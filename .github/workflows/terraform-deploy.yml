name: AWS Terraform Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod
      action:
        description: 'Terraform action to perform'
        required: true
        default: 'plan'
        type: choice
        options:
          - plan
          - apply
          - destroy
      backend_operation:
        description: 'Create backend resources (S3 bucket + DynamoDB)'
        required: false
        default: false
        type: boolean

env:
  TF_VERSION: '1.6.0'
  AWS_REGION: 'us-west-2'
  TF_VAR_region: 'us-west-2'

jobs:
  setup-backend:
    name: Setup S3 Backend
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.backend_operation == 'true' }}
    outputs:
      bucket_name: ${{ steps.backend.outputs.bucket_name }}
      dynamodb_table: ${{ steps.backend.outputs.dynamodb_table }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Create S3 Backend Resources
        id: backend
        run: |
          # Generate unique bucket name
          BUCKET_NAME="terraform-state-$(echo ${{ github.repository_owner }} | tr '[:upper:]' '[:lower:]')-$(date +%s)"
          DYNAMODB_TABLE="terraform-state-locks-$(echo ${{ github.repository_owner }} | tr '[:upper:]' '[:lower:]')"
          
          echo "Creating S3 bucket: $BUCKET_NAME"
          aws s3 mb s3://$BUCKET_NAME --region ${{ env.AWS_REGION }}
          
          # Enable versioning
          aws s3api put-bucket-versioning \
            --bucket $BUCKET_NAME \
            --versioning-configuration Status=Enabled
          
          # Enable encryption
          aws s3api put-bucket-encryption \
            --bucket $BUCKET_NAME \
            --server-side-encryption-configuration '{
              "Rules": [
                {
                  "ApplyServerSideEncryptionByDefault": {
                    "SSEAlgorithm": "AES256"
                  }
                }
              ]
            }'
          
          # Block public access
          aws s3api put-public-access-block \
            --bucket $BUCKET_NAME \
            --public-access-block-configuration \
            "BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true"
          
          echo "Creating DynamoDB table: $DYNAMODB_TABLE"
          aws dynamodb create-table \
            --table-name $DYNAMODB_TABLE \
            --attribute-definitions AttributeName=LockID,AttributeType=S \
            --key-schema AttributeName=LockID,KeyType=HASH \
            --provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
            --region ${{ env.AWS_REGION }}
          
          # Wait for table to be created
          aws dynamodb wait table-exists --table-name $DYNAMODB_TABLE --region ${{ env.AWS_REGION }}
          
          echo "bucket_name=$BUCKET_NAME" >> $GITHUB_OUTPUT
          echo "dynamodb_table=$DYNAMODB_TABLE" >> $GITHUB_OUTPUT
          
          echo "Backend resources created successfully!"
          echo "S3 Bucket: $BUCKET_NAME"
          echo "DynamoDB Table: $DYNAMODB_TABLE"
          echo "Please update your backend configuration with these values."

  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    needs: [setup-backend]
    if: ${{ always() && (github.event.inputs.action == 'plan' || github.event.inputs.action == 'apply') }}
    outputs:
      plan_output: ${{ steps.plan.outputs.stdout }}
      plan_exitcode: ${{ steps.plan.outputs.exitcode }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Terraform Init
        working-directory: terraform-templates/aws/environments/${{ github.event.inputs.environment }}
        run: |
          # Initialize without backend if backend was just created
          if [[ "${{ github.event.inputs.backend_operation }}" == "true" ]]; then
            terraform init
          else
            # Initialize with existing backend (backend config should be provided via -backend-config)
            terraform init \
              -backend-config="bucket=${{ secrets.TF_STATE_BUCKET || needs.setup-backend.outputs.bucket_name }}" \
              -backend-config="key=aws/${{ github.event.inputs.environment }}/terraform.tfstate" \
              -backend-config="region=${{ env.AWS_REGION }}" \
              -backend-config="dynamodb_table=${{ secrets.TF_STATE_DYNAMODB_TABLE || needs.setup-backend.outputs.dynamodb_table }}" \
              -backend-config="encrypt=true"
          fi

      - name: Terraform Validate
        working-directory: terraform-templates/aws/environments/${{ github.event.inputs.environment }}
        run: terraform validate

      - name: Terraform Plan
        id: plan
        working-directory: terraform-templates/aws/environments/${{ github.event.inputs.environment }}
        run: |
          terraform plan \
            -var-file="terraform.tfvars" \
            -out=tfplan \
            -detailed-exitcode

      - name: Upload Plan Artifact
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-aws-${{ github.event.inputs.environment }}
          path: terraform-templates/aws/environments/${{ github.event.inputs.environment }}/tfplan
          retention-days: 30

      - name: Comment PR with Plan
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const output = `#### Terraform Plan for AWS ${{ github.event.inputs.environment }} ðŸª´
            
            <details><summary>Show Plan</summary>
            
            \`\`\`terraform
            ${{ steps.plan.outputs.stdout }}
            \`\`\`
            
            </details>
            
            *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

  terraform-apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    needs: [terraform-plan, setup-backend]
    if: ${{ always() && github.event.inputs.action == 'apply' && needs.terraform-plan.outputs.plan_exitcode == '2' }}
    environment: 
      name: aws-${{ github.event.inputs.environment }}
      url: ${{ steps.apply.outputs.cluster_endpoint }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Download Plan Artifact
        uses: actions/download-artifact@v4
        with:
          name: terraform-plan-aws-${{ github.event.inputs.environment }}
          path: terraform-templates/aws/environments/${{ github.event.inputs.environment }}

      - name: Terraform Init
        working-directory: terraform-templates/aws/environments/${{ github.event.inputs.environment }}
        run: |
          if [[ "${{ github.event.inputs.backend_operation }}" == "true" ]]; then
            terraform init
          else
            terraform init \
              -backend-config="bucket=${{ secrets.TF_STATE_BUCKET || needs.setup-backend.outputs.bucket_name }}" \
              -backend-config="key=aws/${{ github.event.inputs.environment }}/terraform.tfstate" \
              -backend-config="region=${{ env.AWS_REGION }}" \
              -backend-config="dynamodb_table=${{ secrets.TF_STATE_DYNAMODB_TABLE || needs.setup-backend.outputs.dynamodb_table }}" \
              -backend-config="encrypt=true"
          fi

      - name: Terraform Apply
        id: apply
        working-directory: terraform-templates/aws/environments/${{ github.event.inputs.environment }}
        run: |
          terraform apply tfplan
          
          # Capture outputs
          CLUSTER_ENDPOINT=$(terraform output -raw cluster_endpoint 2>/dev/null || echo "")
          echo "cluster_endpoint=$CLUSTER_ENDPOINT" >> $GITHUB_OUTPUT

      - name: Update Kubeconfig
        if: ${{ steps.apply.outputs.cluster_endpoint != '' }}
        run: |
          aws eks update-kubeconfig \
            --region ${{ env.AWS_REGION }} \
            --name $(terraform -chdir=terraform-templates/aws/environments/${{ github.event.inputs.environment }} output -raw cluster_name)

      - name: Verify Deployment
        if: ${{ steps.apply.outputs.cluster_endpoint != '' }}
        run: |
          kubectl get nodes
          kubectl get pods -A

  terraform-destroy:
    name: Terraform Destroy
    runs-on: ubuntu-latest
    needs: [setup-backend]
    if: ${{ always() && github.event.inputs.action == 'destroy' }}
    environment: 
      name: aws-${{ github.event.inputs.environment }}-destroy
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        working-directory: terraform-templates/aws/environments/${{ github.event.inputs.environment }}
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets.TF_STATE_BUCKET }}" \
            -backend-config="key=aws/${{ github.event.inputs.environment }}/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ secrets.TF_STATE_DYNAMODB_TABLE }}" \
            -backend-config="encrypt=true"

      - name: Terraform Destroy
        working-directory: terraform-templates/aws/environments/${{ github.event.inputs.environment }}
        run: |
          terraform destroy \
            -var-file="terraform.tfvars" \
            -auto-approve